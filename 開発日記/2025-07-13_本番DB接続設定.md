# 2025-07-13: 本番DB接続設定

## 作業内容
- 本番環境PostgreSQLデータベース接続設定
- データベース接続ライブラリの実装
- 接続テスト用APIエンドポイントの作成
- 初期データベーススキーマの実行

## 技術的な決定事項
- **データベース接続方式**: PostgreSQL接続プールを使用
- **SSL接続**: 本番環境では必須、開発環境では無効化
- **接続プール設定**: 最大20接続、アイドルタイムアウト30秒
- **環境変数管理**: `.env.local`で本番DB接続情報を管理

## 実装内容
### 環境変数設定
- `.env.local`ファイル作成
- 本番PostgreSQL接続文字列設定
- NextAuth設定追加

### データベース接続ライブラリ
- `src/lib/database.ts`実装
- 接続プール管理機能
- クエリ実行ヘルパー関数
- トランザクション実行機能
- 接続テスト機能

### APIエンドポイント
- `/api/test-db`: データベース接続テスト
- `/api/init-db`: 初期スキーマ実行

### データベーススキーマ実行
本番データベースに以下のテーブルを作成：
- `casts`: キャスト基本情報
- `cast_photos`: 写真管理
- `cast_stats`: 能力値（レーダーチャート用）
- `badges`: バッジマスタ
- `cast_badges`: キャストとバッジの関連
- `users`: 管理者ユーザー

## 課題と解決策
### 課題
- 本番環境での直接開発リスク
- SSL接続の適切な設定

### 解決策
- 接続プールでコネクション管理を最適化
- 環境別のSSL設定で適切にセキュリティ確保
- テスト用APIで接続状況を随時確認可能

## 検証結果
- データベース接続テスト: ✅ 成功
- スキーマ初期化: ✅ 成功
- 本番環境との共有開発環境構築完了

## 次回のタスク
- [ ] キャストデータのCRUD API実装
- [ ] ホーム画面（キャスト一覧）実装
- [ ] キャスト詳細画面実装
- [ ] 管理画面実装

## 参考リンク
- [node-postgres Documentation](https://node-postgres.com/)
- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [PostgreSQL SSL](https://www.postgresql.org/docs/current/ssl-tcp.html)