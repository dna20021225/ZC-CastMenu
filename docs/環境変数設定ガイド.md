# 環境変数設定ガイド

このドキュメントでは、ZC-CastMenuの環境変数設定方法を説明します。

## 目次
1. [開発環境の設定](#開発環境の設定)
2. [本番環境の設定（Vercel）](#本番環境の設定vercel)
3. [Tursoアカウント作成とデータベース設定](#tursoアカウント作成とデータベース設定)

---

## 開発環境の設定

### 1. .envファイルの作成

プロジェクトルートに `.env.local` ファイルを作成します：

```bash
cp .env.example .env.local
```

### 2. 必要な環境変数

開発環境では以下の設定のみ必要です：

```env
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=development-secret-key-change-in-production
```

**データベースについて:**
- 開発環境では **ローカルSQLiteファイル** (`data/castmenu.db`) を自動的に使用します
- データベース関連の環境変数設定は不要です

### 3. データベース初期化

初回起動時、以下のAPIエンドポイントにアクセスしてデータベースを初期化します：

```
http://localhost:3000/api/init-db
```

ブラウザで上記URLにアクセスするか、curlコマンドで実行：

```bash
curl http://localhost:3000/api/init-db
```

成功すると `data/castmenu.db` ファイルが作成されます。

---

## 本番環境の設定（Vercel）

### 概要

本番環境では **Turso**（リモートSQLite）を使用します。
理由: Vercelはサーバーレス環境のため、ファイルシステムが一時的です。各リクエスト処理後に環境が破棄されるため、永続的なデータ保存にはリモートデータベースが必要です。

### 1. Tursoアカウント作成

1. [Turso公式サイト](https://turso.tech/)にアクセス
2. GitHubアカウントでサインアップ（無料）
3. 無料プラン:
   - ストレージ: 8GB
   - 月間読み取り: 10億行
   - 月間書き込み: 2500万行
   - **このプロジェクトには十分すぎる容量です**

### 2. Tursoデータベース作成

Turso CLIをインストール（ターミナルで実行）：

```bash
# macOS/Linux
curl -sSfL https://get.tur.so/install.sh | bash

# Windows（PowerShell）
irm get.tur.so/install.ps1 | iex
```

ログイン：

```bash
turso auth login
```

データベース作成：

```bash
# データベース作成
turso db create zc-castmenu

# データベースURL取得
turso db show zc-castmenu --url

# 認証トークン作成
turso db tokens create zc-castmenu
```

出力例：
```
Database URL: libsql://zc-castmenu-xxxxx.turso.io
Auth Token: eyJhbGc...（長いトークン文字列）
```

### 3. Vercel環境変数設定

1. [Vercelダッシュボード](https://vercel.com/dashboard)にアクセス
2. プロジェクト `zc-castmenu` を選択
3. **Settings** → **Environment Variables** を開く
4. 以下の環境変数を追加：

| 変数名 | 値 | 環境 |
|--------|-----|------|
| `TURSO_DATABASE_URL` | `libsql://zc-castmenu-xxxxx.turso.io` | Production, Preview |
| `TURSO_AUTH_TOKEN` | `eyJhbGc...` | Production, Preview |
| `NEXTAUTH_URL` | `https://zc-castmenu.vercel.app` | Production |
| `NEXTAUTH_SECRET` | ランダムな文字列（32文字以上推奨） | Production, Preview |

**NEXTAUTH_SECRETの生成方法:**
```bash
openssl rand -base64 32
```

### 4. データベース初期化（本番環境）

環境変数設定後、以下のURLにアクセスしてデータベースを初期化：

```
https://zc-castmenu.vercel.app/api/init-db
```

成功メッセージが表示されればOKです。

---

## Tursoアカウント作成とデータベース設定

### ステップ1: アカウント作成

1. https://turso.tech/ にアクセス
2. **Start Building** をクリック
3. GitHubアカウントでサインアップ
4. 無料プランを選択

### ステップ2: データベース作成（WebUI）

Turso CLIを使わずに、WebUIで作成することもできます：

1. Tursoダッシュボードにログイン
2. **Create Database** ボタンをクリック
3. データベース名: `zc-castmenu`
4. リージョン: `Tokyo (Asia)` を選択（推奨）
5. **Create** をクリック

### ステップ3: 認証情報取得

1. 作成したデータベースをクリック
2. **Connection** タブを開く
3. **Database URL** をコピー
4. **Create Token** ボタンをクリック
5. **Auth Token** をコピー

これらをVercelの環境変数に設定します。

---

## トラブルシューティング

### データベース接続エラー

**エラー:** `TURSO_DATABASE_URL and TURSO_AUTH_TOKEN must be set`

**解決策:**
1. Vercelの環境変数が正しく設定されているか確認
2. 環境変数設定後、再デプロイが必要な場合があります

### 開発環境でTursoを使いたい場合

`.env.local` に以下を追加：

```env
USE_TURSO=true
TURSO_DATABASE_URL=libsql://zc-castmenu-xxxxx.turso.io
TURSO_AUTH_TOKEN=your-auth-token
```

---

## まとめ

- **開発環境**: ローカルSQLite（`data/castmenu.db`）を自動使用
- **本番環境**: Turso（リモートSQLite）を使用
- **環境変数**: Vercelで設定、開発環境では最小限でOK
- **データベース初期化**: `/api/init-db` にアクセス
